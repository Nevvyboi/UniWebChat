<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UniWebChat - Conversations</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --theme-color: #4a6bff;
      --bg-color: #f5f7fb;
      --sidebar-bg: #ffffff;
      --text-color: #333333;
      --border-color: #e6e6e6;
      --message-received-bg: #f1f3f6;
      --message-sent-bg: #e6eeff;
      --active-conversation-bg: #f0f5ff;
      --theme-secondary: #667eea;
      --theme-tertiary: #764ba2;
    }

    body.dark-mode {
      --bg-color: #1a1a1a;
      --sidebar-bg: #242424;
      --text-color: #f0f0f0;
      --border-color: #404040;
      --message-received-bg: #2d2d2d;
      --message-sent-bg: #2a3d6d;
      --active-conversation-bg: #2c3f63;
      --theme-secondary: #3a4785;
      --theme-tertiary: #2a3655;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--theme-color) 0%, var(--theme-secondary) 50%, var(--theme-tertiary) 100%);
      color: var(--text-color);
      transition: all 0.3s ease;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 0, 0, 0.06) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      z-index: -1;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-14px) rotate(1deg); }
      66% { transform: translateY(8px) rotate(-1deg); }
    }

    .app-container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 20px auto;
      background-color: var(--sidebar-bg);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.22);
      height: calc(100vh - 40px);
    }

    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      background-color: var(--theme-color);
      color: white;
    }

    .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 18px;
    }

    .logo i {
      margin-right: 10px;
    }

    .user-actions button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 10px;
      width: 36px;
      height: 36px;
      color: white;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s;
    }

    .user-actions button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    
    .nav-tabs {
      display: flex;
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(6px);
      padding-left: 8px;
    }

    .nav-tab {
      padding: 12px 18px;
      cursor: pointer;
      font-weight: 500;
      position: relative;
    }

    .nav-tab.active {
      color: var(--theme-color);
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      left: 18px;
      right: 18px;
      bottom: 0;
      height: 3px;
      border-radius: 3px;
      background: var(--theme-color);
    }

    .dark-mode .nav-tabs {
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid #2a2e36;
    }

    .dark-mode .nav-tab {
      color: #b4bad0;
    }

    .dark-mode .nav-tab.active {
      color: var(--theme-color);
    }

    
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .conversations-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    
    .conversations-sidebar {
      width: 280px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .search-box {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .search-box i {
      margin-right: 10px;
      color: #777;
    }

    .search-box input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      color: var(--text-color);
      font-size: 14px;
    }

    .conversation-list {
      list-style: none;
      overflow-y: auto;
      flex: 1;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }

    .conversation-item:hover {
      background-color: var(--active-conversation-bg);
    }

    .conversation-item.active {
      background-color: var(--active-conversation-bg);
    }

    .conversation-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--theme-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }

    .conversation-info {
      margin-left: 10px;
      overflow: hidden;
    }

    .conversation-name {
      font-weight: 500;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-preview {
      font-size: 12px;
      color: #777;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    
    .conversations-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
    }

    .chat-header {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background-color: var(--sidebar-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .chat-header .conversation-avatar {
      margin-right: 10px;
    }

    .chat-header .conversation-name {
      font-size: 15px;
    }

    .chat-header .conversation-preview {
      font-size: 12px;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
    }

    .message.received {
      align-self: flex-start;
      background-color: var(--message-received-bg);
      border-bottom-left-radius: 4px;
    }

    .message.sent {
      align-self: flex-end;
      background-color: var(--message-sent-bg);
      border-bottom-right-radius: 4px;
    }

    .message-sender {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 3px;
    }

    .message-time {
      font-size: 11px;
      color: #777;
      text-align: right;
      margin-top: 3px;
    }

    .chat-input {
      display: flex;
      padding: 12px;
      background-color: var(--sidebar-bg);
      border-top: 1px solid var(--border-color);
    }

    .chat-input input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      outline: none;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 14px;
    }

    .chat-input button {
      margin-left: 10px;
      padding: 10px 16px;
      background-color: var(--theme-color);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }

    
    .theme-blue {
      --theme-color: #4a6bff;
      --theme-secondary: #667eea;
      --theme-tertiary: #764ba2;
    }

    .theme-red {
      --theme-color: #ff4757;
      --theme-secondary: #ff6b7a;
      --theme-tertiary: #c44569;
    }

    .theme-green {
      --theme-color: #2ed573;
      --theme-secondary: #7bed9f;
      --theme-tertiary: #5f27cd;
    }

    .theme-orange {
      --theme-color: #ffa502;
      --theme-secondary: #ff6348;
      --theme-tertiary: #ff4757;
    }

    
    .floating-controls {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      width: 90px;
      height: 90px;
    }

    .main-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--theme-color);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      position: absolute;
      bottom: 0;
      right: 0;
    }

    .main-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
    }

    .dark-mode .main-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid var(--theme-color);
    }

    .theme-options {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s;
    }

    .floating-controls:hover .theme-options,
    .theme-options:hover {
      opacity: 1;
      visibility: visible;
    }

    .theme-option {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .theme-option:hover {
      transform: scale(1.1);
    }

    .theme-option.active {
      border-color: #ffd700;
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
    }

    .dark-mode .theme-option {
      border-color: rgba(255, 255, 255, 0.8);
    }

    .theme-option:nth-child(1) {
      top: -70px;
      left: -70px;
      background: linear-gradient(135deg, #4a6bff, #667eea);
    }

    .theme-option:nth-child(2) {
      top: -75px;
      left: -5px;
      background: linear-gradient(135deg, #ff4757, #ff6b7a);
    }

    .theme-option:nth-child(3) {
      top: -5px;
      left: -75px;
      background: linear-gradient(135deg, #2ed573, #7bed9f);
    }

    .main-toggle::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: var(--theme-color);
      animation: pulse 2s infinite;
      z-index: -1;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.3;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    
    @media (max-width: 768px) {
      .conversations-sidebar {
        width: 220px;
      }
      
      .message {
        max-width: 90%;
      }
      
      .app-container {
        margin: 10px;
        height: calc(100vh - 20px);
      }
    }

    @media (max-width: 576px) {
      .conversations-container {
        flex-direction: column;
      }
      
      .conversations-sidebar {
        width: 100%;
        height: 40%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
      
      .floating-controls {
        bottom: 20px;
        right: 20px;
      }
    }

    .connection-status {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
    }

    .connection-status.connected {
      background: #2ed573;
    }

    .connection-status.disconnected {
      background: #ff4757;
    }
  </style>
</head>
<body class="theme-blue">
  <div class="app-container">
    
    <div class="header">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
        <span>UniWebChat</span>
      </div>
      <div class="user-actions">
        <button title="Camera" onclick="window.location.href='camera.html'"><i class="fas fa-camera"></i></button>
        <button title="Settings"><i class="fas fa-cog"></i></button>
        <button title="Logout" id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
    
    
    <div class="nav-tabs">
      <div class="nav-tab" onclick="window.location.href='home.html'">Home</div>
      <div class="nav-tab active">Conversations</div>
    </div>
    
    
    <div class="content">
      <div class="conversations-container">
        <div class="conversations-sidebar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search conversations...">
          </div>
          
          <ul class="conversation-list">
            <li class="conversation-item active">
              <div class="conversation-avatar">IT</div>
              <div class="conversation-info">
                <div class="conversation-name">ITEJA3-33 Group</div><div id="whoami-badge" style="margin-left:8px;font-size:12px;opacity:.8;"></div>
              </div>
            </li>
          </ul>
        </div>
        
        <div class="conversations-main">
          <div class="chat-header">
            <div class="conversation-avatar">IT</div>
            <div>
              <div class="conversation-name">ITEJA3-33 Group</div><div id="whoami-badge" style="margin-left:8px;font-size:12px;opacity:.8;"></div>
              <div class="connection-status disconnected" id="connection-status">Disconnected</div>
            </div>
          </div>
          
          <div class="chat-messages" id="chat-thread">
            
          </div>
          
          <div class="chat-input">
            <input type="text" placeholder="Type a message..." id="messageInput">
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <div class="floating-controls">
    <button class="main-toggle" id="main-toggle">
      <i class="fas fa-sun"></i>
    </button>
    <div class="theme-options">
      <button class="theme-option active" data-theme="blue" title="Ocean Blue"></button>
      <button class="theme-option" data-theme="red" title="Sunset Red"></button>
      <button class="theme-option" data-theme="green" title="Forest Green"></button>
    </div>
  </div>

  <script>
    
    (function () {
      const state = {
        username: 'Me',
        room: 'ITEJA3-33 Group',
        ws: null,
        connected: false
      };

      
      window.state = state;

      
      const chatThread = document.getElementById('chat-thread');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const connectionStatus = document.getElementById('connection-status');

      
      function esc(s) { 
        return String(s ?? '').replace(/[&<>"']/g, c => 
          ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
      }

      function renderMessage(msg) {
        const isMe = msg.sender === state.username;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isMe ? 'sent' : 'received'}`;
        
        const d = msg.sentAt ? new Date(msg.sentAt) : new Date();
        const timeString = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        messageElement.innerHTML = `
          ${!isMe ? `<div class="message-sender">${esc(msg.sender)}</div>` : ''}
          <div class="message-text">${esc(msg.content)}</div>
          <div class="message-time">${timeString}</div>
        `;
        
        chatThread.appendChild(messageElement);
        chatThread.scrollTop = chatThread.scrollHeight;
      }

      function clearThread() {
        chatThread.innerHTML = '';
      }

      // Send message
      function sendCurrentMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        const msg = {
          sender: state.username,
          room: state.room,
          content: text,
          sentAt: Date.now()
        };
        
        // Optimistic render
        renderMessage(msg);
        messageInput.value = '';

        try {
          state.ws?.send(JSON.stringify({ type: 'message', ...msg }));
        } catch(e) {
          console.warn('WS send failed', e);
        }
      }

      // WebSocket helpers
      function wsUrlFor(room) {
        const loc = window.location;
        const scheme = (loc.protocol === 'https:') ? 'wss' : 'ws';
        const ctx = loc.pathname.split('/')[1] || '';
        // Assume endpoint mapped at /chat
        return `${scheme}://${loc.host}/${ctx ? ctx + '/' : ''}chat?room=${encodeURIComponent(room)}&sender=${encodeURIComponent(state.username)}`;
      }

      function connectWs() {
        try {
          state.ws = new WebSocket(wsUrlFor(state.room));
        } catch (e) {
          console.warn('WS create failed', e);
          return;
        }

        state.ws.addEventListener('open', () => { 
          state.connected = true;
          connectionStatus.textContent = 'Connected';
          connectionStatus.className = 'connection-status connected';
          const badge = document.getElementById('whoami-badge');
          if (badge) badge.textContent = '(' + state.username + ')';
        });
        
        state.ws.addEventListener('close', () => { 
          state.connected = false;
          connectionStatus.textContent = 'Disconnected';
          connectionStatus.className = 'connection-status disconnected';
        });
        
        state.ws.addEventListener('error', () => { 
          try{state.ws.close();}catch{} 
        });

        state.ws.addEventListener('message', (ev) => {
          let data;
          try { data = JSON.parse(ev.data); } catch { data = null; }
          if (!data || !data.content) return;

          // Avoid double-render for my own echoes
          if (data.sender === state.username && data.content) return;

          renderMessage({
            sender: data.sender || 'Someone',
            content: data.content || '',
            sentAt: data.sentAt || Date.now(),
            room: data.room || state.room
          });
        });
      }

      // Load user info
      function appCtx() {
        const p = window.location.pathname.split('/');
        return p.length > 1 ? '/' + p[1] : '';
      }

      async function loadMe() {
        try {
          const res = await fetch(appCtx() + '/whoami', { credentials: 'include' });
          if (res.ok) {
            const text = (await res.text()).trim();
            let me = null; try { me = JSON.parse(text); } catch {}
            const who = (me && me.username) ? String(me.username).trim() : (text || '');
            if (who) { state.username = who; }
          }
        } catch (e) {
          console.warn('whoami failed', e);
        }

        if (!state.username || !state.username.trim()) {
          try {
            const stored = sessionStorage.getItem('username') || localStorage.getItem('username');
            if (stored) state.username = stored.trim();
          } catch {}
        }

        if (!state.username || !state.username.trim()) {
          state.username = 'User' + Math.floor(100 + Math.random()*900);
        }

        try {
          sessionStorage.setItem('username', state.username);
          localStorage.setItem('username', state.username);
        } catch {}
      }

      // Wire UI

      sendBtn?.addEventListener('click', sendCurrentMessage);
      messageInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendCurrentMessage();
        }
      });

      // Init flow
      (async function init() {
  await loadMe();                    // must be first
  const active = document.querySelector('.conversation-item.active');
  if (active) { /* no-op UI setup here */ }
  connectWs();                       // open WS after username is set
})();
    })();

    // Theme & Dark Mode (persisted)
    (function() {
      const THEME_KEY = 'uwc-theme';
      const DARK_KEY = 'uwc-dark';
      
      // Apply theme
      function applyTheme(theme) {
        if (!theme) return;
        document.body.classList.remove('theme-blue', 'theme-red', 'theme-green', 'theme-orange');
        document.body.classList.add('theme-' + theme);
        
        // Update active theme option
        document.querySelectorAll('.theme-option').forEach(opt => {
          opt.classList.toggle('active', opt.dataset.theme === theme);
        });
      }
      
      // Apply dark mode
      function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        const mainToggle = document.getElementById('main-toggle');
        if (mainToggle) {
          mainToggle.innerHTML = isDark ? 
            '<i class="fas fa-moon"></i>' : 
            '<i class="fas fa-sun"></i>';
        }
      }
      
      // Restore saved settings
      function restoreSettings() {
        try {
          const savedTheme = localStorage.getItem(THEME_KEY) || 'blue';
          const savedDark = localStorage.getItem(DARK_KEY) === 'true';
          
          applyTheme(savedTheme);
          applyDarkMode(savedDark);
        } catch (e) {
          console.error('Error restoring settings:', e);
        }
      }
      
      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        restoreSettings();
        
        // Theme options
        document.querySelectorAll('.theme-option').forEach(option => {
          option.addEventListener('click', () => {
            const theme = option.dataset.theme;
            applyTheme(theme);
            try {
              localStorage.setItem(THEME_KEY, theme);
            } catch (e) {
              console.error('Error saving theme:', e);
            }
          });
        });
        
        // Dark mode toggle
        const mainToggle = document.getElementById('main-toggle');
        if (mainToggle) {
          mainToggle.addEventListener('click', () => {
            const isDark = !document.body.classList.contains('dark-mode');
            applyDarkMode(isDark);
            try {
              localStorage.setItem(DARK_KEY, isDark);
            } catch (e) {
              console.error('Error saving dark mode:', e);
            }
          });
        }
      });
    })();
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', () => {
  const p = window.location.pathname.split('/');
  const ctx = p.length > 1 ? '/' + p[1] : '';
  window.location.href = ctx + '/logout';
});
  </script>


<script>
(function () {
  function waitForWsOpen(cb) {
    var start = Date.now(), max = 15000;
    var iv = setInterval(function () {
      if (window.state && window.state.ws && window.state.ws.readyState === 1) {
        clearInterval(iv); cb(window.state.ws);
      } else if (Date.now() - start > max) {
        clearInterval(iv);
      }
    }, 200);
  }

  function renderMedia(msg) {
    try {
      var thread = document.getElementById('chat-thread') || document.querySelector('.chat-thread');
      if (!thread) return;
      var isMe = (window.state && msg.sender === window.state.username);
      var row = document.createElement('div');
      row.className = 'msg-row ' + (isMe ? 'me' : 'other');

      var bubble = document.createElement('div');
      bubble.className = 'bubble';

      var who = document.createElement('div');
      who.className = 'meta';
      who.textContent = isMe ? 'You' : (msg.sender || 'Someone');
      bubble.appendChild(who);

      if (msg.mediaType === 'image') {
        var img = document.createElement('img');
        img.src = msg.data;
        img.style.maxWidth = '240px';
        img.style.borderRadius = '8px';
        bubble.appendChild(img);
      } else if (msg.mediaType === 'video') {
        var vid = document.createElement('video');
        vid.src = msg.data;
        vid.controls = true;
        vid.style.maxWidth = '240px';
        vid.style.borderRadius = '8px';
        bubble.appendChild(vid);
      } else {
        var t = document.createElement('div');
        t.textContent = '[Unsupported media]';
        bubble.appendChild(t);
      }

      row.appendChild(bubble);
      thread.appendChild(row);
      thread.scrollTop = thread.scrollHeight;
    } catch (e) {}
  }

  function hookWsForMedia() {
    if (!window.state || !window.state.ws) return;
    if (window.state.__mediaHooked) return; 
    window.state.__mediaHooked = true;
    window.state.ws.addEventListener('message', function (ev) {
      try {
        var data = JSON.parse(ev.data);
        if (data && data.type === 'media') renderMedia(data);
      } catch (e) {}
    });
  }

  function sendPending() {
    try {
      var raw = sessionStorage.getItem('pendingMedia');
      if (!raw) return;
      var msg = JSON.parse(raw);
      if (window.state && window.state.ws && window.state.ws.readyState === 1) {
        window.state.ws.send(JSON.stringify(msg));
        renderMedia(Object.assign({}, msg, { sender: msg.sender || (window.state && window.state.username) }));
        sessionStorage.removeItem('pendingMedia');
      }
    } catch (e) {}
  }

  function start() {
    waitForWsOpen(function () {
      hookWsForMedia();
      sendPending();
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
  else start();
})();
</script>

</body>
</html>